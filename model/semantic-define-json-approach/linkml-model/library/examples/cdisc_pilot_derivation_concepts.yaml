# CDISC Pilot Study - Derivation Concepts
#
# This file contains library DerivationConcept definitions for ADAS-Cog
# assessment data used in the CDISC Pilot study analyses. These concepts
# describe how ADaM variables are derived from SDTM source data.
#
# Reference: CDISC Pilot Study ADaM Define-XML, ADQSADAS dataset

libraryOID: "LIB.CDISC.PILOT.DC"
libraryName: "CDISC Pilot Derivation Concepts"
version: "1.0"

concepts:
  # ==========================================================================
  # ADAS-Cog Assessment Score Derivations
  # ==========================================================================

  - OID: "DC.ADASCOG.SCORE"
    name: "ADAS-Cog Total Score"
    conceptType: "derivation_concept"
    semanticRole: "assessment_score"
    label: "ADAS-Cog (11) total score"
    description: >-
      Alzheimer's Disease Assessment Scale - Cognitive Subscale (ADAS-Cog)
      total score using the 11-item version. Sum of 11 cognitive task scores
      ranging from 0 (no impairment) to 70 (severe impairment). Higher scores
      indicate greater cognitive impairment.

    purpose: >-
      Derive the primary efficacy variable (ADAS-Cog total score) from
      individual item responses collected in SDTM QS domain.

    inputs:
      - OID: "DC.ADASCOG.SCORE.INPUT.QSORRES"
        name: "qs_result"
        semanticRole: "source_variable"
        dataType: "float"
        required: true
        description: "Individual ADAS-Cog item score from QS.QSORRES"
        sourceDataset: "QS"
        sourceVariable: "QSORRES"

      - OID: "DC.ADASCOG.SCORE.INPUT.QSTESTCD"
        name: "test_code"
        semanticRole: "selector"
        dataType: "text"
        required: true
        description: "Test code to select ADAS-Cog items (ACTOT11)"
        sourceDataset: "QS"
        sourceVariable: "QSTESTCD"

      - OID: "DC.ADASCOG.SCORE.INPUT.VISITNUM"
        name: "visit_number"
        semanticRole: "temporal_selector"
        dataType: "integer"
        required: true
        description: "Visit number for assessment timing"
        sourceDataset: "QS"
        sourceVariable: "VISITNUM"

    outputs:
      - OID: "DC.ADASCOG.SCORE.OUTPUT.AVAL"
        name: "analysis_value"
        semanticRole: "derived_variable"
        dataType: "float"
        description: "ADAS-Cog total score (AVAL in ADQSADAS)"
        targetDataset: "ADQSADAS"
        targetVariable: "AVAL"

    derivationMethod: >-
      Sum the scores from 11 ADAS-Cog cognitive items for subjects with
      QSTESTCD = 'ACTOT11' at each visit. Scores range from 0-70.

    implementsConcept:
      - "BC.ASSESSMENT.COGNITIVE"
      - "BC.SCORE.TOTAL"

  - OID: "DC.ADASCOG.BASELINE"
    name: "ADAS-Cog Baseline Score"
    conceptType: "derivation_concept"
    semanticRole: "baseline_value"
    label: "Baseline ADAS-Cog score"
    description: >-
      Baseline ADAS-Cog total score, typically the last non-missing score
      prior to first study treatment. Used as covariate in ANCOVA models
      and as reference for change from baseline calculations.

    purpose: >-
      Derive the baseline reference value for efficacy analyses, ensuring
      consistent baseline definition across all analyses.

    inputs:
      - OID: "DC.ADASCOG.BASELINE.INPUT.AVAL"
        name: "analysis_value"
        semanticRole: "source_variable"
        dataType: "float"
        required: true
        description: "ADAS-Cog score at each visit"
        sourceVariable: "AVAL"

      - OID: "DC.ADASCOG.BASELINE.INPUT.ABLFL"
        name: "baseline_flag"
        semanticRole: "selector"
        dataType: "text"
        required: true
        description: "Baseline record flag (ABLFL='Y')"
        sourceVariable: "ABLFL"

    outputs:
      - OID: "DC.ADASCOG.BASELINE.OUTPUT.BASE"
        name: "baseline_value"
        semanticRole: "derived_variable"
        dataType: "float"
        description: "Baseline ADAS-Cog score (BASE in ADQSADAS)"
        targetDataset: "ADQSADAS"
        targetVariable: "BASE"

    derivationMethod: >-
      Carry forward the AVAL where ABLFL='Y' (baseline record) to all
      post-baseline records for the same subject and parameter.

    implementsConcept:
      - "BC.BASELINE.VALUE"

  - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE"
    name: "Change from Baseline in ADAS-Cog"
    conceptType: "derivation_concept"
    semanticRole: "change_from_baseline"
    label: "ADAS-Cog change from baseline"
    description: >-
      Change from baseline in ADAS-Cog total score, calculated as post-baseline
      score minus baseline score. Primary efficacy outcome for ANCOVA analyses.
      Negative values indicate improvement (decreased impairment).

    purpose: >-
      Derive the primary analysis variable for treatment comparisons, measuring
      change in cognitive function from pre-treatment baseline.

    inputs:
      - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE.INPUT.AVAL"
        name: "post_baseline_value"
        semanticRole: "source_variable"
        dataType: "float"
        required: true
        description: "Post-baseline ADAS-Cog score"
        sourceVariable: "AVAL"

      - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE.INPUT.BASE"
        name: "baseline_value"
        semanticRole: "source_variable"
        dataType: "float"
        required: true
        description: "Baseline ADAS-Cog score"
        sourceVariable: "BASE"

    outputs:
      - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE.OUTPUT.CHG"
        name: "change_value"
        semanticRole: "derived_variable"
        dataType: "float"
        description: "Change from baseline (CHG in ADQSADAS)"
        targetDataset: "ADQSADAS"
        targetVariable: "CHG"

    derivationMethod: >-
      CHG = AVAL - BASE
      Calculated for all post-baseline records where both AVAL and BASE
      are non-missing. Negative values indicate improvement.

    implementsConcept:
      - "BC.CHANGE.FROM.BASELINE"

  - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE_LOCF"
    name: "Change from Baseline with LOCF"
    conceptType: "derivation_concept"
    semanticRole: "imputed_change"
    label: "LOCF-imputed change from baseline"
    description: >-
      Change from baseline in ADAS-Cog with Last Observation Carried Forward
      (LOCF) imputation for missing post-baseline values. Used in sensitivity
      analyses under conservative missing data assumptions.

    purpose: >-
      Derive change from baseline with LOCF imputation for analyses requiring
      complete data at target visit (e.g., Week 24 ANCOVA with LOCF).

    inputs:
      - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE_LOCF.INPUT.CHG"
        name: "observed_change"
        semanticRole: "source_variable"
        dataType: "float"
        required: true
        description: "Observed change from baseline (non-imputed)"
        sourceVariable: "CHG"

      - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE_LOCF.INPUT.VISITNUM"
        name: "visit_number"
        semanticRole: "temporal_selector"
        dataType: "integer"
        required: true
        description: "Visit number for LOCF logic"
        sourceVariable: "VISITNUM"

      - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE_LOCF.INPUT.TARGET_VISIT"
        name: "target_visit"
        semanticRole: "parameter"
        dataType: "integer"
        required: true
        description: "Target analysis visit (e.g., 24 for Week 24)"

    outputs:
      - OID: "DC.ADASCOG.CHANGE_FROM_BASELINE_LOCF.OUTPUT.CHGLOCF"
        name: "change_locf"
        semanticRole: "derived_variable"
        dataType: "float"
        description: "LOCF-imputed change (custom variable or DTYPE='LOCF')"
        targetDataset: "ADQSADAS"
        targetVariable: "CHG"
        targetDerivationType: "LOCF"

    derivationMethod: >-
      For target visit: If CHG is missing, carry forward the last non-missing
      CHG from a prior post-baseline visit. If no prior post-baseline CHG exists,
      value remains missing (subject excluded from LOCF analysis).

    implementsConcept:
      - "BC.CHANGE.FROM.BASELINE"
      - "BC.IMPUTATION.LOCF"

  # ==========================================================================
  # Treatment and Population Variables
  # ==========================================================================

  - OID: "DC.TREATMENT.PLANNED"
    name: "Planned Treatment"
    conceptType: "derivation_concept"
    semanticRole: "treatment_classification"
    label: "Planned treatment group"
    description: >-
      Treatment assigned at randomization, used for intent-to-treat analyses.
      Derived from randomization system or SDTM DM domain.

    purpose: >-
      Classify subjects by planned treatment for efficacy analyses following
      intent-to-treat principle.

    inputs:
      - OID: "DC.TREATMENT.PLANNED.INPUT.ARM"
        name: "study_arm"
        semanticRole: "source_variable"
        dataType: "text"
        required: true
        description: "Planned arm from DM.ARM"
        sourceDataset: "DM"
        sourceVariable: "ARM"

    outputs:
      - OID: "DC.TREATMENT.PLANNED.OUTPUT.TRT01P"
        name: "planned_treatment"
        semanticRole: "derived_variable"
        dataType: "text"
        description: "Planned treatment (TRT01P in ADSL)"
        targetDataset: "ADSL"
        targetVariable: "TRT01P"

      - OID: "DC.TREATMENT.PLANNED.OUTPUT.TRT01PN"
        name: "planned_treatment_num"
        semanticRole: "derived_variable"
        dataType: "integer"
        description: "Planned treatment numeric (TRT01PN in ADSL)"
        targetDataset: "ADSL"
        targetVariable: "TRT01PN"

    derivationMethod: >-
      TRT01P = ARM (from randomization)
      TRT01PN: Placebo=0, Low Dose=54, High Dose=81 (dose in mg)

  - OID: "DC.POPULATION.EFFICACY_FLAG"
    name: "Efficacy Population Flag"
    conceptType: "derivation_concept"
    semanticRole: "population_indicator"
    label: "Efficacy analysis set flag"
    description: >-
      Flag indicating inclusion in efficacy analysis population. Typically
      requires: randomization, at least one dose of study treatment, and at
      least one post-baseline efficacy assessment.

    purpose: >-
      Identify subjects eligible for efficacy analyses based on treatment
      exposure and data availability criteria.

    inputs:
      - OID: "DC.POPULATION.EFFICACY_FLAG.INPUT.RANDFL"
        name: "randomized_flag"
        semanticRole: "criterion"
        dataType: "text"
        required: true
        description: "Randomized flag"
        sourceDataset: "ADSL"
        sourceVariable: "RANDFL"

      - OID: "DC.POPULATION.EFFICACY_FLAG.INPUT.TRTSDT"
        name: "treatment_start_date"
        semanticRole: "criterion"
        dataType: "date"
        required: true
        description: "Treatment start date (non-missing = treated)"
        sourceDataset: "ADSL"
        sourceVariable: "TRTSDT"

      - OID: "DC.POPULATION.EFFICACY_FLAG.INPUT.POST_BASE_OBS"
        name: "has_post_baseline"
        semanticRole: "criterion"
        dataType: "boolean"
        required: true
        description: "Has at least one post-baseline ADAS-Cog assessment"

    outputs:
      - OID: "DC.POPULATION.EFFICACY_FLAG.OUTPUT.EFFFL"
        name: "efficacy_flag"
        semanticRole: "derived_variable"
        dataType: "text"
        description: "Efficacy population flag (EFFFL in ADSL)"
        targetDataset: "ADSL"
        targetVariable: "EFFFL"

    derivationMethod: >-
      EFFFL = 'Y' if:
        - RANDFL = 'Y' (randomized)
        - TRTSDT is not missing (received at least one dose)
        - Subject has at least one post-baseline ADAS-Cog score
      Otherwise EFFFL = 'N'

  # ==========================================================================
  # Visit and Timing Variables
  # ==========================================================================

  - OID: "DC.VISIT.ANALYSIS_VISIT"
    name: "Analysis Visit"
    conceptType: "derivation_concept"
    semanticRole: "temporal_classification"
    label: "Analysis visit grouping"
    description: >-
      Standardized analysis visit derived from scheduled or unscheduled visit
      dates, mapped to protocol-defined analysis timepoints. Handles visit
      windows and unscheduled visits.

    purpose: >-
      Classify assessment records into standardized analysis visits for
      consistent temporal grouping across analyses.

    inputs:
      - OID: "DC.VISIT.ANALYSIS_VISIT.INPUT.VISIT"
        name: "visit"
        semanticRole: "source_variable"
        dataType: "text"
        required: true
        description: "Visit name from QS.VISIT"
        sourceDataset: "QS"
        sourceVariable: "VISIT"

      - OID: "DC.VISIT.ANALYSIS_VISIT.INPUT.VISITNUM"
        name: "visit_number"
        semanticRole: "source_variable"
        dataType: "integer"
        required: true
        description: "Visit number from QS.VISITNUM"
        sourceDataset: "QS"
        sourceVariable: "VISITNUM"

      - OID: "DC.VISIT.ANALYSIS_VISIT.INPUT.ADT"
        name: "assessment_date"
        semanticRole: "temporal_reference"
        dataType: "date"
        required: true
        description: "Assessment date"

    outputs:
      - OID: "DC.VISIT.ANALYSIS_VISIT.OUTPUT.AVISIT"
        name: "analysis_visit"
        semanticRole: "derived_variable"
        dataType: "text"
        description: "Analysis visit (AVISIT in ADQSADAS)"
        targetDataset: "ADQSADAS"
        targetVariable: "AVISIT"

      - OID: "DC.VISIT.ANALYSIS_VISIT.OUTPUT.AVISITN"
        name: "analysis_visit_num"
        semanticRole: "derived_variable"
        dataType: "integer"
        description: "Analysis visit number (AVISITN in ADQSADAS)"
        targetDataset: "ADQSADAS"
        targetVariable: "AVISITN"

    derivationMethod: >-
      Map VISIT and VISITNUM to standardized analysis visits:
      - Baseline: VISITNUM=1, AVISIT='Baseline', AVISITN=0
      - Week 8: VISITNUM=3, AVISIT='Week 8', AVISITN=8
      - Week 16: VISITNUM=5, AVISIT='Week 16', AVISITN=16
      - Week 24: VISITNUM=7, AVISIT='Week 24', AVISITN=24
      Unscheduled visits mapped to nearest scheduled visit based on visit window.

  - OID: "DC.BASELINE.FLAG"
    name: "Baseline Record Flag"
    conceptType: "derivation_concept"
    semanticRole: "record_classifier"
    label: "Baseline record indicator"
    description: >-
      Flag identifying the baseline record for each subject and parameter.
      Typically the last non-missing assessment prior to first treatment dose.

    purpose: >-
      Identify the single baseline record used for baseline value (BASE)
      and change from baseline calculations.

    inputs:
      - OID: "DC.BASELINE.FLAG.INPUT.AVAL"
        name: "analysis_value"
        semanticRole: "criterion"
        dataType: "float"
        required: true
        description: "Assessment value (must be non-missing)"
        sourceVariable: "AVAL"

      - OID: "DC.BASELINE.FLAG.INPUT.ADT"
        name: "assessment_date"
        semanticRole: "criterion"
        dataType: "date"
        required: true
        description: "Assessment date"
        sourceVariable: "ADT"

      - OID: "DC.BASELINE.FLAG.INPUT.TRTSDT"
        name: "treatment_start_date"
        semanticRole: "criterion"
        dataType: "date"
        required: true
        description: "First treatment date from ADSL"
        sourceDataset: "ADSL"
        sourceVariable: "TRTSDT"

    outputs:
      - OID: "DC.BASELINE.FLAG.OUTPUT.ABLFL"
        name: "baseline_flag"
        semanticRole: "derived_variable"
        dataType: "text"
        description: "Analysis baseline flag (ABLFL in ADQSADAS)"
        targetDataset: "ADQSADAS"
        targetVariable: "ABLFL"

    derivationMethod: >-
      ABLFL = 'Y' for the record with:
        - AVAL is non-missing
        - ADT <= TRTSDT (on or before first dose)
        - Latest ADT among all qualifying pre-treatment records
      All other records: ABLFL = null or 'N'
